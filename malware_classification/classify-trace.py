import sys

import numpy as np
import pandas as pd
from joblib import load


def read_csv(filename):
    data = [str(line.split(',')) for line in open(filename, 'r')]
    df = pd.DataFrame({'traces': data})
    return df


def preprocess(df):
    df.drop_duplicates(subset=['traces'], inplace=True)
    df.replace([np.inf], np.finfo(np.float32).max, inplace=True)  # Replace inf values with max of float 32
    df.replace([-np.inf], -np.finfo(np.float32).min, inplace=True)  # Replace inf values with min value of float 32
    df.fillna(0, inplace=True)  # Replace all NaN values with 0
    vectorizer = load('vectorizer.joblib')
    df = vectorizer.transform(df['traces'])
    scaler = load('scaler.joblib')
    df = scaler.transform(df.toarray())
    return df


def main():

    if len(sys.argv) != 2:
        print("Usage: python classify-trace.py <filename>")
        sys.exit(1)

    clf = load('classifier.joblib')
    df = read_csv(sys.argv[1])
    df = preprocess(df)

    for line in df:
        label = clf.predict(line.reshape(1, -1))
        label = str(label).replace('[', '').replace(']', '').replace('\'', '').replace('\\n', '')
        print(label)


main()
